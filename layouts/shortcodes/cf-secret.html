<!-- layouts/shortcodes/cf-secret.html -->
{{ $slug := .Get "slug" }} {{ $workerUrl := .Get "url" | default
"https://secure-content-worker.err0rpro.workers.dev" }}

<div class="cf-secret-container" id="secret-{{ $slug }}">
  <div class="cf-secret-lock">
    <h3>ğŸ”’ æ­ä¸ï¼</h3>
    <p>é€™å€‹æ–‡ç« è¢«å¯†ç¢¼ç¶æ¶äº†ï¼Œè«‹è¼¸å…¥å¯†é‘°ä»¥è§£é–å…§å®¹ã€‚</p>
    <div class="cf-input-group">
      <input
        type="password"
        id="pass-{{ $slug }}"
        placeholder="è¼¸å…¥å¯†é‘°"
        onkeypress="if(event.key==='Enter') fetchSecret('{{ $slug }}', '{{ $workerUrl }}')"
      />
      <button onclick="fetchSecret('{{ $slug }}', '{{ $workerUrl }}')">
        è§£é–
      </button>
    </div>
    <p id="msg-{{ $slug }}" class="cf-msg"></p>
  </div>
  <div
    id="content-{{ $slug }}"
    class="cf-content markdown-body"
    style="display: none"
  ></div>
</div>

<!-- å¼•å…¥ Marked.js ç”¨æ–¼å‰ç«¯ Markdown æ¸²æŸ“ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- å¼•å…¥ Highlight.js ç”¨æ–¼ä»£ç¢¼è¢å…‰ (å¯é¸ï¼Œé…åˆæ‚¨çš„ä¸»é¡Œ) -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<style>
  .cf-secret-container {
    margin: 20px 0;
  }
  /* é–é ­å€å¡Šä¿ç•™æ¨£å¼ï¼Œè®“å®ƒçœ‹èµ·ä¾†åƒå€‹å¡ç‰‡ */
  .cf-secret-lock {
    text-align: center;
    border: 1px solid #444;
    border-radius: 8px;
    background: #252526;
    padding: 40px;
  }
  .cf-input-group {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 15px 0;
  }
  .cf-input-group input {
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #666;
    background: #333;
    color: white;
  }
  .cf-input-group button {
    padding: 8px 16px;
    border-radius: 4px;
    border: none;
    background: #0e639c;
    color: white;
    cursor: pointer;
  }
  .cf-input-group button:hover {
    background: #1177bb;
  }
  .cf-msg {
    min-height: 20px;
    font-size: 0.9em;
  }
  /* å…§å®¹å€å¡Šç§»é™¤æ‰€æœ‰è£é£¾ï¼Œä½¿å…¶èå…¥èƒŒæ™¯ */
  .cf-content {
    margin-top: 0;
  }
</style>

<script>
  async function fetchSecret(slug, workerUrl) {
    const passInput = document.getElementById("pass-" + slug);
    const msg = document.getElementById("msg-" + slug);
    const contentDiv = document.getElementById("content-" + slug);
    const lockDiv = document.querySelector(
      "#secret-" + slug + " .cf-secret-lock",
    );

    const password = passInput.value;
    if (!password) return;

    msg.textContent = "é©—è­‰ä¸­...";
    msg.style.color = "#ccc";

    try {
      // æ³¨æ„: è‹¥æ‚¨çš„ Worker åœ¨ä¸åŒåŸŸåï¼Œè«‹ç¢ºä¿ Worker è¨­å®šäº†æ­£ç¢ºçš„ CORS
      const response = await fetch(workerUrl + "/api/get-secret", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ slug, password }),
      });

      if (response.status === 200) {
        const data = await response.json();

        // ä½¿ç”¨ Marked è§£æ Markdown
        contentDiv.innerHTML = marked.parse(data.content);

        // æ‡‰ç”¨èªæ³•é«˜äº® (å¦‚æœæœ‰çš„è©±)
        contentDiv.querySelectorAll("pre code").forEach((el) => {
          hljs.highlightElement(el);
        });

        // UI åˆ‡æ›
        lockDiv.style.display = "none";
        contentDiv.style.display = "block";
      } else if (response.status === 401) {
        msg.textContent = "å¯†ç¢¼éŒ¯èª¤ã€‚";
        msg.style.color = "#ff6b6b";
      } else {
        const errData = await response.json();
        msg.textContent = errData.error || "é©—è­‰å¤±æ•—";
        msg.style.color = "#ff6b6b";
      }
    } catch (e) {
      console.error(e);
      msg.textContent = "é€£ç·šéŒ¯èª¤";
      msg.style.color = "#ff6b6b";
    }
  }
</script>
